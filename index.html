<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumo diário do cronograma</title>
  <style>
    :root{
      --bg:#f5f7fb; --ink:#0f172a; --muted:#64748b; --brand:#ec4899;
      --card:#ffffff; --line:#e2e8f0; --chip:#111827; --chipText:#f8fafc;
      --warnBg:#fff7e6; --warnBorder:#facc15; --dark:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    header h1{font-size:22px;margin:0;font-weight:800}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
    select,button{border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;font:inherit;cursor:pointer}
    button.primary{background:var(--brand);border-color:var(--brand);color:white;font-weight:700}
    .note{background:var(--warnBg);border:1px solid var(--warnBorder);padding:12px 14px;border-radius:10px;margin:10px 0 16px;color:#7a5b00}
    .darkbox{background:var(--dark);color:#e5e7eb;border-radius:12px;padding:16px 18px;margin:8px 0 18px}
    .darkbox .m{color:#9ca3af}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px 16px 12px}
    .card h3{margin:0 0 6px;font-size:16px;font-weight:800;display:flex;align-items:center;gap:10px}
    .chip{display:inline-block;background:var(--chip);color:var(--chipText);border-radius:999px;padding:2px 10px;font-size:12px;font-weight:700}
    .section{margin:12px 0 8px}
    .sectionTitle{font-weight:800;margin:0 0 6px}
    .line{white-space:pre-wrap;margin:0 0 6px}
    .divider{height:1px;background:var(--line);margin:10px 0}
    .block{margin:0 0 12px}
    .q{color:var(--muted);font-weight:600}
    .a{white-space:pre-wrap;margin-top:2px}
    .card .actions{margin-top:8px}
    .card button{padding:8px 10px;border-radius:10px}
    .muted{color:var(--muted)}
    .counts{font-weight:700;margin:6px 0 0}
    .footnote{color:var(--muted);font-size:12px;margin-top:4px}

    /* Toast */
    .toast{
      position:fixed;left:50%;bottom:24px;transform:translateX(-50%) translateY(20px);
      background:#0f172a;color:#f8fafc;border-radius:10px;padding:10px 14px;
      box-shadow:0 10px 30px rgba(0,0,0,.2);opacity:0;pointer-events:none;
      transition:opacity .25s ease, transform .25s ease;font-weight:600;z-index:9999
    }
    .toast.show{opacity:1;transform:translateX(-50%) translateY(0)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Resumo diário do cronograma</h1>
      <button id="btnCopyAll" class="primary">Copiar tudo</button>
    </header>

    <div class="toolbar">
      <label for="selDay" class="muted">Histórico (últimos 14 dias):</label>
      <select id="selDay"></select>
    </div>

    <div class="note">
      A janela fecha às <b>16:00</b> e só troca para o próximo dia às <b>08:00</b>.
    </div>

    <div id="infoBox" class="darkbox">
      <div id="windowLabel">Carregando janela…</div>
      <div class="m" id="genInfo">–</div>
      <div class="counts" id="counts">Total de solicitações: –</div>
    </div>

    <div id="cards" class="grid"></div>

    <div class="footnote">
      Ao copiar para o WhatsApp: o título sai em <code>*negrito*</code>, cada bloco <code>*Edital X*</code> vem compacto (só as respostas), e em “Outras informações” somente as perguntas ficam em <code>_itálico_</code>.
    </div>
  </div>

  <!-- Toast -->
  <div id="toast" class="toast">copiado para área de transferência</div>

  <script>
    /* Proxy local da Vercel (api/gs.js). */
    const API_LOCAL = "/api/gs";

    /* Limpezas de perguntas */
    const SPECIAL_Q = "Quer incluir ou remover alguma disciplina do seu cronograma?";
    const RX_SEM_EDITAL = /\(\s*se\s+for\s+sem\s+edital\s+aberto,\s*escreva\s+isso\s+na\s+(?:última|última|próxima|próxima)\s+pergunta\s*\)/gi;
    const RX_INSIRA_CARGO = /insira\s+aqui\s+o\s+cargo\s*\(\s*s[eé]?\s*necess[aá]rio\s*\)\s*e\s*informe\s*se\s*for\s*um\s*edital\s*que\s*ainda\s*n[aã]o\s*tem\s*data\s*de\s*prova/gi;

    function cleanQuestionHeader(h) {
      let s = String(h || "").trim();
      s = s.replace(RX_SEM_EDITAL, "").replace(RX_INSIRA_CARGO, "").trim();
      if (s.toLowerCase().startsWith(SPECIAL_Q.toLowerCase())) return SPECIAL_Q;
      return s;
    }

    /* Seletores de campos de edital */
    const EDITAL_RX = n => new RegExp(`^\\s*edital\\s*${n}\\b`, "i");
    const NOME_RX   = /nome\s*do\s*concurso/i;
    const DATA_RX   = /data\s*da\s*prova/i;
    const OBS_RX    = /observa/i;               // Observações
    const LINK_RX   = /link\s*do\s*edital/i;

    const selDay = document.getElementById("selDay");
    const btnCopyAll = document.getElementById("btnCopyAll");
    const cardsEl = document.getElementById("cards");
    const windowLabelEl = document.getElementById("windowLabel");
    const genInfoEl = document.getElementById("genInfo");
    const countsEl = document.getElementById("counts");
    const toastEl = document.getElementById("toast");

    let currentSummary = null;

    init();
    scheduleAutoRefreshAt8am();

    async function apiGet(params){
      const url = API_LOCAL + "?" + new URLSearchParams(params).toString();
      const r = await fetch(url, { cache: "no-store" });
      if (!r.ok) throw new Error("Falha ao consultar API");
      return await r.json();
    }

    async function init(){
      try{
        currentSummary = await apiGet({ action: "summary" });
        renderSummary(currentSummary);

        const hist = await apiGet({ action: "history" });
        fillHistorySelect(hist && hist.windows ? hist.windows : [], currentSummary);
      }catch(err){
        windowLabelEl.textContent = "Erro ao carregar dados.";
        genInfoEl.textContent = String(err);
      }
    }

    function fillHistorySelect(windows, summary){
      selDay.innerHTML = "";
      windows.forEach((w)=>{
        const opt = document.createElement("option");
        opt.value = w.startISO + "||" + w.endISO;
        opt.textContent = w.label;
        selDay.appendChild(opt);
      });

      const cur = summary && summary.window ? (summary.window.startISO + "||" + summary.window.endISO) : null;
      if(cur){
        const found = Array.from(selDay.options).find(o => o.value === cur);
        if(found) found.selected = true;
      }

      selDay.addEventListener("change", onHistoryChange);
      btnCopyAll.addEventListener("click", copyAll);
    }

    async function onHistoryChange(){
      const [startISO, endISO] = selDay.value.split("||");
      try{
        currentSummary = await apiGet({ action: "summary", startISO, endISO });
        renderSummary(currentSummary);
      }catch(err){
        windowLabelEl.textContent = "Erro ao carregar janela selecionada.";
        genInfoEl.textContent = String(err);
      }
    }

    /* --------- Lógica de agrupamento e renderização --------- */

    function groupEditais(fields){
      // Retorna { editais: [{n, values:[...]}], outros:[fields] }
      const matchedIndex = new Set();
      const editais = [];

      for (const n of [1,2,3]){
        const rx = EDITAL_RX(n);
        const subset = fields
          .map((f, idx) => ({...f, _i: idx}))
          .filter(f => rx.test(f.header));

        if (subset.length === 0) continue;

        const pick = (re) => {
          const f = subset.find(ff => re.test(ff.header));
          if (f && f.value && String(f.value).trim() !== "") {
            matchedIndex.add(f._i);
            return String(f.value).trim();
          }
          return null;
        };

        const values = [];
        const nome = pick(NOME_RX); if (nome) values.push(nome);
        const data = pick(DATA_RX); if (data) values.push(data);
        const obs  = pick(OBS_RX);  if (obs)  values.push(obs);
        const link = pick(LINK_RX); if (link) values.push(link);

        // Se não achou nenhum dos 4 “principais”, ainda assim
        // mostra outros campos do Edital X (caso existam).
        if (values.length === 0){
          subset.forEach(ff=>{
            if (ff.value && String(ff.value).trim()){
              matchedIndex.add(ff._i);
              values.push(String(ff.value).trim());
            }
          });
        }

        if (values.length > 0){
          editais.push({ n, values });
        }
      }

      const outros = fields.filter((_, i)=> !matchedIndex.has(i));
      return { editais, outros };
    }

    function renderSummary(sum){
      if(sum && sum.window){
        windowLabelEl.textContent = "Janela: " + sum.window.label;
      }else{
        windowLabelEl.textContent = "Janela atual";
      }
      genInfoEl.textContent = `Gerado em ${sum.generatedAt || "-"} | Fuso: ${sum.timezone || "-"}`;
      const c = sum.counts || { total:0, simples:0, complexo:0 };
      countsEl.textContent = `Total de solicitações: ${c.total} (Simples: ${c.simples} • Complexo: ${c.complexo})`;

      cardsEl.innerHTML = "";
      const items = (sum && sum.items) ? sum.items : [];
      if(items.length === 0){
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "Nenhuma solicitação nesta janela.";
        cardsEl.appendChild(empty);
        return;
      }

      items.forEach((it, idx)=>{
        const card = document.createElement("div");
        card.className = "card";

        const h3 = document.createElement("h3");
        const titleText = `SOLICITAÇÃO ${idx+1} — ${it.tipo}`;
        h3.appendChild(document.createTextNode(titleText));
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = new Date(it.timestampISO).toLocaleString();
        h3.appendChild(chip);
        card.appendChild(h3);

        const { editais, outros } = groupEditais(it.fields || []);

        // Seções de Editais (condensadas)
        editais.forEach(sec=>{
          const s = document.createElement("div");
          s.className = "section";
          const t = document.createElement("div");
          t.className = "sectionTitle";
          t.textContent = `Edital ${sec.n}`;
          s.appendChild(t);
          sec.values.forEach(v=>{
            const ln = document.createElement("div");
            ln.className = "line";
            ln.textContent = v;
            s.appendChild(ln);
          });
          card.appendChild(s);
        });

        if (editais.length > 0 && outros.length > 0){
          const div = document.createElement("div");
          div.className = "divider";
          card.appendChild(div);
        }

        // Outras informações (pergunta/resposta)
        if (outros.length > 0){
          const sec = document.createElement("div");
          sec.className = "section";
          const t = document.createElement("div");
          t.className = "sectionTitle muted";
          t.textContent = "Outras informações";
          sec.appendChild(t);

          outros.forEach(f=>{
            const block = document.createElement("div");
            block.className = "block";
            const q = document.createElement("div");
            q.className = "q";
            q.textContent = cleanQuestionHeader(f.header);
            const a = document.createElement("div");
            a.className = "a";
            a.textContent = f.value ?? "";
            block.appendChild(q); block.appendChild(a);
            sec.appendChild(block);
          });

          card.appendChild(sec);
        }

        // Ações
        const actions = document.createElement("div");
        actions.className = "actions";
        const btn = document.createElement("button");
        btn.textContent = "Copiar";
        btn.addEventListener("click", ()=>copyText(buildCopyFromItem(it)));
        actions.appendChild(btn);
        card.appendChild(actions);

        cardsEl.appendChild(card);
      });
    }

    /* --------- Cópia para WhatsApp (com novo layout) --------- */

    function buildCopyFromItem(it){
      const lines = [];
      const title = it.whatsAppTitle || `*SOLICITAÇÃO — ${it.tipo || "SIMPLES"}*`;
      lines.push(title);

      const { editais, outros } = groupEditais(it.fields || []);

      // Blocos de Editais
      editais.forEach(sec=>{
        lines.push(`*Edital ${sec.n}*`);
        sec.values.forEach(v => lines.push(String(v)));
        lines.push(""); // linha em branco entre blocos
      });

      // Outras informações
      if (outros.length){
        lines.push("_Outras informações_");
        outros.forEach(f=>{
          lines.push(`_${cleanQuestionHeader(f.header)}_`);
          lines.push(String(f.value ?? ""));
          lines.push("");
        });
      }

      // Remove linhas em branco excedentes no final
      while(lines.length && lines[lines.length-1] === "") lines.pop();
      return lines.join("\n");
    }

    async function copyAll(){
      const items = (currentSummary && currentSummary.items) ? currentSummary.items : [];
      const blocks = items.map(it => buildCopyFromItem(it));
      const big = blocks.join("\n\n");
      copyText(big);
    }

    /* --------- Utilidades de cópia e toast --------- */

    function copyText(text){
      if(!text) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{ showToast(); })
          .catch(()=>{ legacyCopy(text); });
      }else{
        legacyCopy(text);
      }
    }

    function legacyCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); showToast(); }
      catch(e){ alert("Copie manualmente:\n\n" + text); }
      ta.remove();
    }

    let toastTimer = null;
    function showToast(){
      toastEl.classList.add("show");
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=> toastEl.classList.remove("show"), 1200);
    }

    /* --------- Atualização automática às 08:00 --------- */

    function scheduleAutoRefreshAt8am(){
      const now = new Date();
      const next = new Date(now);
      next.setHours(8,0,0,0);
      if(now >= next){ next.setDate(next.getDate()+1); }
      const ms = next - now;
      setTimeout(async ()=>{
        try{
          currentSummary = await apiGet({ action: "summary" });
          renderSummary(currentSummary);
        }finally{
          scheduleAutoRefreshAt8am();
        }
      }, ms);
    }
  </script>
</body>
</html>
