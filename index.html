<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Resumo diário do cronograma</title>
  <style>
    :root{
      --bg:#f5f7fb;
      --ink:#0f172a;
      --muted:#475569;
      --brand:#ec4899;
      --card:#ffffff;
      --line:#e2e8f0;
      --chip:#111827;
      --chipText:#f8fafc;
      --warnBg:#fff7e6;
      --warnBorder:#facc15;
      --dark:#0b1220;
    }
    *{box-sizing:border-box}
    html,body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial}
    .wrap{max-width:1100px;margin:24px auto;padding:0 16px}
    header{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin-bottom:12px}
    header h1{font-size:22px;margin:0;font-weight:800}
    .toolbar{display:flex;gap:12px;flex-wrap:wrap;align-items:center;margin:8px 0 16px}
    select,button{
      border:1px solid var(--line);background:#fff;border-radius:10px;padding:10px 12px;font:inherit;cursor:pointer
    }
    button.primary{background:var(--brand);border-color:var(--brand);color:white;font-weight:700}
    .note{
      background:var(--warnBg);border:1px solid var(--warnBorder);
      padding:12px 14px;border-radius:10px;margin:10px 0 16px;color:#7a5b00
    }
    .darkbox{
      background:var(--dark);color:#e5e7eb;border-radius:12px;padding:16px 18px;margin:8px 0 18px
    }
    .darkbox .m{color:#9ca3af}
    .grid{display:grid;grid-template-columns:1fr;gap:14px}
    @media (min-width:860px){ .grid{grid-template-columns:1fr} }
    .card{
      background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px 16px 12px
    }
    .card h3{margin:0 0 6px;font-size:16px;font-weight:800;display:flex;align-items:center;gap:10px}
    .chip{
      display:inline-block;background:var(--chip);color:var(--chipText);
      border-radius:999px;padding:2px 10px;font-size:12px;font-weight:700
    }
    .fields{margin:10px 0 8px;border-top:1px dashed var(--line);padding-top:10px}
    .row{display:flex;gap:8px;margin:3px 0;align-items:flex-start}
    .key{min-width:180px;color:var(--muted)}
    .val{white-space:pre-wrap}
    .card .actions{margin-top:10px}
    .card button{padding:8px 10px;border-radius:10px}
    .muted{color:var(--muted)}
    .counts{font-weight:700;margin:6px 0 0}
    .right{margin-left:auto}
    .sep{height:1px;background:var(--line);margin:12px 0}
    .footnote{color:var(--muted);font-size:12px;margin-top:4px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>Resumo diário do cronograma</h1>
      <button id="btnCopyAll" class="primary">Copiar tudo</button>
      <div class="right"></div>
    </header>

    <div class="toolbar">
      <label for="selDay" class="muted">Histórico (últimos 14 dias):</label>
      <select id="selDay"></select>
    </div>

    <div class="note">
      A janela fecha às <b>16:00</b> e só troca para o próximo dia às <b>08:00</b>.
    </div>

    <div id="infoBox" class="darkbox">
      <div id="windowLabel">Carregando janela…</div>
      <div class="m" id="genInfo">–</div>
      <div class="counts" id="counts">Total de solicitações: –</div>
    </div>

    <div id="cards" class="grid"></div>

    <div class="footnote">
      Dica: o título dos cards já vem em <code>*asteriscos*</code> no texto copiado para aparecer em negrito no WhatsApp.
    </div>
  </div>

  <script>
    // === CONFIG ===
    // Sua URL pública do Apps Script (fornecida por você):
    const API_BASE = "https://script.google.com/macros/s/AKfycbwQKE1-rZjds0531to4Qb07rBYx_1WsxNwh6-5TVAtWuyu6824wRuPBqFG4C4f48Anx/exec";

    // Utilitário JSONP para contornar CORS
    function jsonp(url){
      return new Promise((resolve,reject)=>{
        const cb = "cb_"+Math.random().toString(36).slice(2);
        const s = document.createElement("script");
        const timeout = setTimeout(()=>{ cleanup(); reject(new Error("Timeout JSONP")); }, 30000);
        window[cb] = data => { cleanup(); resolve(data); };
        function cleanup(){
          clearTimeout(timeout);
          delete window[cb];
          s.remove();
        }
        s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cb;
        s.onerror = ()=>{ cleanup(); reject(new Error("Falha ao carregar JSONP")); };
        document.body.appendChild(s);
      });
    }

    const selDay = document.getElementById("selDay");
    const btnCopyAll = document.getElementById("btnCopyAll");
    const cardsEl = document.getElementById("cards");
    const windowLabelEl = document.getElementById("windowLabel");
    const genInfoEl = document.getElementById("genInfo");
    const countsEl = document.getElementById("counts");

    let currentSummary = null;
    let historyList = [];

    // Carregar tudo na inicialização
    init();
    scheduleAutoRefreshAt8am();

    async function init(){
      try{
        // 1) Carrega o resumo "do momento" (Apps Script já calcula a janela correta)
        currentSummary = await jsonp(API_BASE + "?action=summary");
        renderSummary(currentSummary);

        // 2) Carrega histórico e posiciona o select
        const hist = await jsonp(API_BASE + "?action=history");
        historyList = (hist && hist.windows) ? hist.windows : [];
        fillHistorySelect(historyList, currentSummary);
      }catch(err){
        windowLabelEl.textContent = "Erro ao carregar dados.";
        genInfoEl.textContent = String(err);
      }
    }

    function fillHistorySelect(windows, summary){
      selDay.innerHTML = "";
      windows.forEach((w, idx)=>{
        const opt = document.createElement("option");
        opt.value = w.startISO + "||" + w.endISO;
        opt.textContent = w.label;
        selDay.appendChild(opt);
      });

      // Seleciona a janela que bate com a do summary atual, se existir
      const cur = summary && summary.window ? (summary.window.startISO + "||" + summary.window.endISO) : null;
      if(cur){
        const found = Array.from(selDay.options).find(o => o.value === cur);
        if(found) found.selected = true;
      }

      selDay.addEventListener("change", onHistoryChange);
      btnCopyAll.addEventListener("click", copyAll);
    }

    async function onHistoryChange(){
      const [startISO, endISO] = selDay.value.split("||");
      try{
        currentSummary = await jsonp(
          API_BASE + "?action=summary&startISO=" + encodeURIComponent(startISO) +
          "&endISO=" + encodeURIComponent(endISO)
        );
        renderSummary(currentSummary);
      }catch(err){
        windowLabelEl.textContent = "Erro ao carregar janela selecionada.";
        genInfoEl.textContent = String(err);
      }
    }

    function renderSummary(sum){
      // Cabeçalho (janela, geração, contagens)
      if(sum && sum.window){
        windowLabelEl.textContent = "Janela: " + sum.window.label;
      }else{
        windowLabelEl.textContent = "Janela atual";
      }
      genInfoEl.textContent = `Gerado em ${sum.generatedAt || "-"} | Fuso: ${sum.timezone || "-"}`;
      const c = sum.counts || { total:0, simples:0, complexo:0 };
      countsEl.textContent = `Total de solicitações: ${c.total} (Simples: ${c.simples} • Complexo: ${c.complexo})`;

      // Cards
      cardsEl.innerHTML = "";
      const items = (sum && sum.items) ? sum.items : [];
      if(items.length === 0){
        const empty = document.createElement("div");
        empty.className = "card";
        empty.textContent = "Nenhuma solicitação nesta janela.";
        cardsEl.appendChild(empty);
        return;
      }

      items.forEach((it, idx)=>{
        const card = document.createElement("div");
        card.className = "card";

        const h3 = document.createElement("h3");
        const titleText = `SOLICITAÇÃO ${idx+1} — ${it.tipo}`;
        h3.appendChild(document.createTextNode(titleText));
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = new Date(it.timestampISO).toLocaleString();
        h3.appendChild(chip);
        card.appendChild(h3);

        const fieldsBox = document.createElement("div");
        fieldsBox.className = "fields";

        (it.fields || []).forEach(f=>{
          const row = document.createElement("div");
          row.className = "row";
          const key = document.createElement("div");
          key.className = "key";
          key.textContent = f.header + ":";
          const val = document.createElement("div");
          val.className = "val";
          val.textContent = f.value;
          row.appendChild(key);
          row.appendChild(val);
          fieldsBox.appendChild(row);
        });

        card.appendChild(fieldsBox);

        const actions = document.createElement("div");
        actions.className = "actions";
        const btn = document.createElement("button");
        btn.textContent = "Copiar";
        btn.addEventListener("click", ()=>copyText(it.copyText || buildFallbackCopy(it)));
        actions.appendChild(btn);
        card.appendChild(actions);

        cardsEl.appendChild(card);
      });
    }

    // Fallback: se por algum motivo copyText não vier
    function buildFallbackCopy(it){
      const lines = [];
      const title = it.whatsAppTitle || `*SOLICITAÇÃO — ${it.tipo || "SIMPLES"}*`;
      lines.push(title);
      (it.fields || []).forEach(f => lines.push(`${f.header}: ${f.value}`));
      return lines.join("\n");
    }

    async function copyAll(){
      const items = (currentSummary && currentSummary.items) ? currentSummary.items : [];
      const blocks = items.map(it => it.copyText || buildFallbackCopy(it));
      const big = blocks.join("\n\n");
      copyText(big);
    }

    function copyText(text){
      if(!text) return;
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(text).then(()=>{
          flash("Copiado!");
        }).catch(()=>{
          legacyCopy(text);
        });
      }else{
        legacyCopy(text);
      }
    }

    function legacyCopy(text){
      const ta = document.createElement("textarea");
      ta.value = text;
      ta.style.position = "fixed";
      ta.style.left = "-9999px";
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); flash("Copiado!"); }
      catch(e){ alert("Copie manualmente:\n\n" + text); }
      ta.remove();
    }

    function flash(msg){
      btnCopyAll.textContent = msg;
      setTimeout(()=> btnCopyAll.textContent = "Copiar tudo", 1200);
    }

    // Recarrega automaticamente na virada das 08:00
    function scheduleAutoRefreshAt8am(){
      const now = new Date();
      const next = new Date(now);
      next.setHours(8,0,0,0);
      if(now >= next){ next.setDate(next.getDate()+1); } // amanhã às 08:00
      const ms = next - now;
      setTimeout(async ()=>{
        try{
          currentSummary = await jsonp(API_BASE + "?action=summary");
          renderSummary(currentSummary);
        }finally{
          scheduleAutoRefreshAt8am(); // agenda a próxima virada
        }
      }, ms);
    }
  </script>
</body>
</html>
